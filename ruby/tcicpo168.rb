require 'nokogiri'
require 'mechanize'
require 'json'
require 'csv'
require 'logger'

agent = Mechanize.new
# agent.log = Logger.new(STDOUT)

# retirive city codes
# search_page = agent.get('http://www.tebyan-masajed.ir/')
#
# search_form = search_page.form('f1')
# c = search_form.field_with(:id => 'ParentID').options.count
#
# cities = []
#
# for i in 1..(c - 1) do
#   state_select = search_form.field_with(:id => 'ParentID').options[i]
#
#   state_select.select
#   puts state_select.text
#
#   page = agent.submit(search_form)
#   form = page.form('f1')
#
#   cc = form.field_with(:id => 'ParentID1').options
#
#   cc.each {|c| cities << c.value unless c.value == '0'}
#
# end
#
# p cities

cities = ["967", "958", "964", "965", "960", "944", "969", "8140", "966", "974", "975", "970", "962", "972", "6659", "968", "971", "973", "12801", "1403", "10334", "3522", "10915", "1414", "12445", "1423", "11468", "1411", "11217", "4954", "5247", "1417", "11926", "1427", "1420", "1554", "558", "559", "6757", "556", "7597", "554", "557", "1232", "553", "560", "555", "6821", "581", "9275", "579", "1555", "7592", "5010", "582", "578", "7595", "7593", "7594", "590", "588", "586", "584", "8441", "583", "577", "587", "7527", "589", "6635", "585", "580", "10870", "1112", "6808", "12822", "6044", "6810", "607", "1556", "608", "609", "610", "611", "1229", "612", "6529", "5040", "6409", "1557", "625", "627", "6706", "621", "624", "628", "623", "5278", "7301", "622", "626", "7198", "1117", "11138", "1146", "11137", "1558", "1075", "1132", "1142", "1127", "1137", "1109", "4042", "1098", "2239", "1122", "1436", "1433", "12704", "12705", "639", "640", "641", "10550", "6648", "9460", "645", "652", "655", "654", "651", "9733", "649", "9789", "9812", "648", "9195", "9068", "653", "915", "650", "646", "8935", "8936", "647", "8176", "1244", "997", "1261", "1263", "999", "1248", "998", "995", "1252", "1250", "991", "1255", "1001", "993", "1240", "1242", "1003", "1000", "1257", "992", "1004", "996", "1005", "994", "1002", "1259", "672", "670", "667", "668", "673", "669", "671", "1275", "1273", "691", "693", "3222", "687", "694", "686", "689", "695", "1307", "688", "697", "696", "2056", "5153", "6623", "1317", "12026", "3295", "690", "9238", "685", "698", "9455", "1322", "684", "692", "699", "1320", "3234", "6663", "12761", "544", "546", "545", "1559", "1285", "543", "6252", "423", "112", "7110", "425", "1560", "419", "5156", "415", "422", "421", "736", "747", "748", "741", "733", "726", "742", "743", "745", "746", "744", "5261", "767", "764", "758", "772", "757", "762", "774", "11967", "1401", "8148", "766", "6684", "12543", "765", "12062", "769", "5013", "770", "760", "763", "771", "1395", "773", "759", "775", "761", "768", "1398", "353", "12535", "813", "1387", "345", "331", "6411", "1561", "1383", "1562", "817", "816", "1053", "5166", "1047", "10357", "7128", "1057", "1050", "1051", "3292", "1925", "1045", "10435", "1056", "3246", "424", "1049", "3271", "1048", "1052", "8437", "1046", "1054", "1044", "1055", "10874", "1563", "933", "9327", "931", "934", "932", "1361", "935", "1369", "1564", "4971", "4973", "936", "6845", "1363", "1358", "1154", "1171", "1166", "1177", "1160", "1175", "1168", "1158", "1592", "1162", "1179", "1173", "1164", "1527", "1203", "1209", "1207", "1201", "4995", "1189", "1182", "1187", "1191", "1193", "7521", "1199", "1197", "3724", "1205", "1195", "5160", "1210", "1211", "452", "8217", "451", "448", "453", "447", "454", "449", "455", "450", "473", "479", "483", "470", "4958", "482", "472", "480", "471", "476", "468", "478", "481", "6249", "474", "11141", "469", "477", "475", "505", "501", "507", "504", "508", "509", "10926", "502", "506", "511", "503", "510", "9373", "6851", "871", "7565", "852", "870", "1347", "868", "869", "873", "865", "8168", "872", "862", "882", "888", "1471", "887", "1464", "885", "889", "1479", "884", "883", "881", "886", "1565", "904", "918", "920", "921", "909", "906", "1799", "919", "912", "902", "922", "1566", "834", "841", "840", "836", "835", "833", "839", "838", "837", "7506", "1459", "1568", "1461", "534", "1457", "1567", "13282"]

cities.each do |city|
  city_page = agent.get("http://www.tebyan-masajed.ir/Modules/ShowmasajedInCity.aspx?CityId=#{city}")

  doc = Nokogiri::HTML(city_page.body)
  doc.encoding = 'utf-8'
  rows = doc.xpath('//table[@dir="rtl"]/tr/td/a')

  rows. each do |row|
    mosque_page = agent.get("http://www.tebyan-masajed.ir/Modules/#{row.to_h['href']}")

    mosque_page = agent.get('http://www.tebyan-masajed.ir/Masjed-299-12422.aspx/%d8%a7%d8%b5%d8%ba%d8%b1%db%8c%d9%87%20%d8%b2%d9%86%d8%ac%d8%a7%d9%86%db%8c%e2%80%8c%d9%87%d8%a7-%20%d8%ae%20%d9%88%d9%84%db%8c%d8%b9%d8%b5%d8%b1.aspx')

    inner_doc = Nokogiri::HTML(mosque_page.body, nil, 'windows-1256')

    s = mosque_page.body
    s= s.force_encoding 'utf-8'
    p s
    File.open('test.html', 'w:utf-8') { |file| file.write(s) }
    # detail = {}
    # p inner_doc.xpath('//').count

    # p detail

    break
  end


  break
end
